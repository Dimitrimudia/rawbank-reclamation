#!/usr/bin/env bash
# Simplified Maven Wrapper (Linux/macOS) – avoids needing a preinstalled Maven.
# Downloads Apache Maven locally into .mvn/wrapper then delegates all arguments.
set -euo pipefail
MVN_VERSION="3.9.7"
BASE_DIR="$(cd "$(dirname "$0")"; pwd)"
WRAPPER_DIR="${BASE_DIR}/.mvn/wrapper"
DIST_URL="https://archive.apache.org/dist/maven/maven-3/${MVN_VERSION}/binaries/apache-maven-${MVN_VERSION}-bin.tar.gz"
ARCHIVE="${WRAPPER_DIR}/apache-maven-${MVN_VERSION}-bin.tar.gz"
MAVEN_HOME="${WRAPPER_DIR}/apache-maven-${MVN_VERSION}"

mkdir -p "${WRAPPER_DIR}"

if [ ! -d "${MAVEN_HOME}" ]; then
  echo "[mvnw] Téléchargement Maven ${MVN_VERSION}..."
  if command -v curl >/dev/null 2>&1; then
    curl -fSL "${DIST_URL}" -o "${ARCHIVE}"
  elif command -v wget >/dev/null 2>&1; then
    wget "${DIST_URL}" -O "${ARCHIVE}"
  else
    echo "Erreur: curl ou wget requis pour télécharger Maven." >&2
    exit 1
  fi
  tar -xzf "${ARCHIVE}" -C "${WRAPPER_DIR}"
  rm -f "${ARCHIVE}"
fi

MVN_BIN="${MAVEN_HOME}/bin/mvn"
if [ ! -x "${MVN_BIN}" ]; then
  echo "Erreur: mvn introuvable après extraction." >&2
  exit 1
fi

# Multi-module project directory hint
export MAVEN_OPTS="${MAVEN_OPTS:-}" # Conserve MAVEN_OPTS si défini
exec "${MVN_BIN}" -Dmaven.multiModuleProjectDirectory="${BASE_DIR}" "$@"
